<p>twig file rendered</p><br>
<a id="publish2-button">update to all published 2</a><br>
<a id="private-button">update to me only</a><br>
<a id="discover-button">subscribe/discover</a><br>
<script>
    console.log('test123')
    document.getElementById('publish2-button').addEventListener('click', function (event) {
        event.preventDefault()
        fetch('/publish2')
            // .then(response => console.log(response))
    })
    document.getElementById('private-button').addEventListener('click', function (event) {
        event.preventDefault()
        fetch('/private')
            .then(response => console.log(response))
    })
    // werkt niet Unknown: "mercure" function.
    {#const eventSource = new EventSource("{{ mercure([#}
    {#    'https://example.com/books/1',#}
    {#    'https://example.com/books/2',#}
    {#    'https://example.com/reviews/{id}'#}
    {#])|escape('js') }}");#}

    const eventSource2 = new EventSource([
        'http://localhost:3000/.well-known/mercure?topic=' + encodeURIComponent('https://example.com/books/2'),
    ]);
    // eventSource.onmessage = event => {
    //     // Will be called every time an update is published by the server
    //     console.log(JSON.parse(event.data));
    // };
    eventSource2.onmessage = event => {
        // Will be called every time an update is published by the server
        console.log(JSON.parse(event.data));
    };

    // eventSource.onmessage = event => {
    //     console.log(JSON.parse(event.data));
    // }

    // todo: deze aan de praat krijgen 1
    const eventSource3 = new EventSource([
        'http://localhost:3000/.well-known/mercure?topic=' +
        encodeURIComponent('https://example.com/books/3') +
        '&subscribe=' + 'https://example.com/books/3'
    ], {
        withCredentials: true
    });
    eventSource3.onmessage = event => {
        // Will be called every time an update is published by the server
        console.log(JSON.parse(event.data));
    };

    // todo: deze aan de praat krijgen 2
    document.getElementById('discover-button').addEventListener('click', function (event) {
        event.preventDefault()
        fetch('/discover') // Has Link: <http://localhost:3000/.well-known/mercure>; rel="mercure"
            .then(response => {
                console.log(response)
                console.log(response.headers)
                // Extract the hub URL from the Link header
                const hubUrl = response.headers.get('Link').match(/<([^>]+)>;\s+rel=(?:mercure|"[^"]*mercure[^"]*")/)[1];
                console.log(hubUrl)
                console.log(hubUrl.match(/https:\/\/([^\/]+)\/?.*/))
                const newHubUrl = hubUrl.replace(hubUrl.match(/https:\/\/([^\/]+)\/?.*/)[1], 'localhost:3000');
                console.log(newHubUrl)

                // Append the topic(s) to subscribe as query parameter
                const hub = new URL(newHubUrl, window.origin);
                hub.searchParams.append('topic', 'https://example.com/books/{id}');
                // hub.searchParams.append('topic', 'https://example.com/books/3');

                // Subscribe to updates
                // const eventSource = new EventSource(hub);

                const eventSource = new EventSource(hub, {
                    withCredentials: true
                });

                console.log(eventSource)
                eventSource.onmessage = event => console.log(event.data);
            });
    })
</script>
